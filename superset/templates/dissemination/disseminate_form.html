{% extends "appbuilder/base.html" %}
{% import 'appbuilder/general/lib.html' as lib %}

{% block content %}
<div class="container">
    <h3>{{ _("Disseminate Bulletin by Email") }}</h3>
    <br>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {# Display form-wide errors if any (e.g., from flash messages on validation failure) #}
    {% if form and form.errors and form.errors.get('__all__') %}
        <div class="alert alert-danger">
            <p>{{ _("Please correct the errors below:") }}</p>
            <ul>
                {% for error in form.errors['__all__'] %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="POST" action="{{ url_for('DisseminateBulletinView.form') }}" id="disseminationForm">
        {{ form.hidden_tag() }} {# Includes CSRF token #}

        <div class="form-group {% if form.bulletin_id.errors %}has-error{% endif %}">
            {{ form.bulletin_id.label(class_="control-label") }} <span style="color:red;">*</span>
            {{ form.bulletin_id(class_="form-control select2", id="bulletin_id") }}
            {% if form.bulletin_id.errors %}
                <ul class="help-block list-unstyled">{% for error in form.bulletin_id.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
        </div>

        <div class="form-group {% if form.email_group_id.errors %}has-error{% endif %}">
            {{ form.email_group_id.label(class_="control-label") }} <span style="color:red;">*</span>
            {{ form.email_group_id(class_="form-control select2", id="email_group_id") }}
            {% if form.email_group_id.errors %}
                <ul class="help-block list-unstyled">{% for error in form.email_group_id.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
        </div>

        {# Email Preview Area #}
        <div id="email-preview" style="margin-bottom: 15px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background-color: #f9f9f9; min-height: 40px;">
            <small class="text-muted">{{ _("Select an email group to see recipients.") }}</small>
        </div>

        <div class="form-group {% if form.subject.errors %}has-error{% endif %}">
            {{ form.subject.label(class_="control-label") }} <span style="color:red;">*</span>
            {# Pre-fill subject if selected_bulletin is available #}
            {% if selected_bulletin %}
                {{ form.subject(class_="form-control", value=selected_bulletin.title ~ " - Advisory") }}
            {% else %}
                {{ form.subject(class_="form-control", id="subject") }}
            {% endif %}
            {% if form.subject.errors %}
                <ul class="help-block list-unstyled">{% for error in form.subject.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
        </div>

        <div class="form-group {% if form.message.errors %}has-error{% endif %}">
            {{ form.message.label(class_="control-label") }} <span style="color:red;">*</span>
            {# Pre-fill message if selected_bulletin is available #}
            {% if selected_bulletin %}
                {% set initial_message_html %}
<h4>{{ selected_bulletin.title }}</h4>
<p><strong>Advisory:</strong><br>{{ selected_bulletin.advisory.replace('\n', '<br>') if selected_bulletin.advisory else '' }}</p>
<p><strong>Risks:</strong><br>{{ selected_bulletin.risks.replace('\n', '<br>') if selected_bulletin.risks else '' }}</p>
<p><strong>Safety Tips:</strong><br>{{ selected_bulletin.safety_tips.replace('\n', '<br>') if selected_bulletin.safety_tips else '' }}</p>
{% if selected_bulletin.hashtags %}
<p><strong>Hashtags:</strong> {{ selected_bulletin.hashtags }}</p>
{% endif %}
                {% endset %}
                {{ form.message(class_="form-control", rows=10, value=initial_message_html) }}
            {% else %}
                {{ form.message(class_="form-control", rows="10", id="message") }}
            {% endif %}
            <small class="form-text text-muted">
                {{ _("You can customize the message here. JavaScript will attempt to pre-fill this based on the selected bulletin.") }}
            </small>
            {% if form.message.errors %}
                <ul class="help-block list-unstyled">{% for error in form.message.errors %}<li>{{ error }}</li>{% endfor %}</ul>
            {% endif %}
        </div>
        
        {{ form.submit(class_="btn btn-primary") if form else "<button type=\"submit\" class=\"btn btn-primary\">"+_("Disseminate")+"</button>" | safe }}
        <a href="{{ url_for('DisseminatedBulletinLogModelView.list') }}" class="btn btn-default">{{ _("Cancel") }}</a>
    </form>
</div>

{# Data for JavaScript pre-population #}
<script id="bulletins-data-json" type="application/json">
    {{ bulletins_json | safe if bulletins_json else "[]" }}
</script>
<script id="email-groups-data-json" type="application/json">
    {{ email_groups_json | safe if email_groups_json else "[]" }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize Select2
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('#bulletin_id').select2({
            placeholder: "{{ _('-- Select a Bulletin --') }}",
            allowClear: true
        });
        $('#email_group_id').select2({
            placeholder: "{{ _('-- Select an Email Group --') }}",
            allowClear: true
        });
    } else {
        console.warn('Select2 not available for disseminate_form.html');
    }

    // Bulletin auto-population logic
    const bulletinSelect = document.getElementById('bulletin_id');
    const subjectInput = document.getElementById('subject');
    const messageTextarea = document.getElementById('message');
    let bulletinsData = [];
    try {
        const bulletinsDataElement = document.getElementById('bulletins-data-json');
        if (bulletinsDataElement) {
            bulletinsData = JSON.parse(bulletinsDataElement.textContent || '[]');
        }
    } catch (e) {
        console.error("Error parsing bulletins data:", e);
    }
    // Store original subject and message for comparison to avoid overwriting user edits
    let originalSubject = subjectInput.value;
    let originalMessage = messageTextarea.value;
    let isUserEditedSubject = false;
    let isUserEditedMessage = false;

    // Function to update fields based on selected bulletin
    function updateFields() {
        const selectedId = parseInt(bulletinSelect.value);
        const selectedBulletin = bulletinsData.find(b => b.id === selectedId);

        if (selectedBulletin) {
            // Pre-fill subject only if not edited by user or if it matches previous prefill
            const newSubject = `${selectedBulletin.title} - Advisory`;
            if (!isUserEditedSubject || subjectInput.value === originalSubject) {
                subjectInput.value = newSubject;
                originalSubject = newSubject; // Update original prefill reference
            }

            // Construct and pre-fill message only if not edited by user or if it matches previous prefill
            let defaultMessage = `<h4>${selectedBulletin.title}</h4>\n` +
                               `<p><strong>Advisory:</strong><br>${selectedBulletin.advisory ? selectedBulletin.advisory.replace(/\n/g, '<br>') : ''}</p>\n` +
                               `<p><strong>Risks:</strong><br>${selectedBulletin.risks ? selectedBulletin.risks.replace(/\n/g, '<br>') : ''}</p>\n` +
                               `<p><strong>Safety Tips:</strong><br>${selectedBulletin.safety_tips ? selectedBulletin.safety_tips.replace(/\n/g, '<br>') : ''}</p>`;
            if(selectedBulletin.hashtags) {
                defaultMessage += `\n<p><strong>Hashtags:</strong> ${selectedBulletin.hashtags}</p>`;
            }
            if (!isUserEditedMessage || messageTextarea.value === originalMessage) {
                messageTextarea.value = defaultMessage;
                originalMessage = defaultMessage; // Update original prefill reference
            }
        } else {
            // Clear if "-- Select --" is chosen and not user-edited
            if (!isUserEditedSubject || subjectInput.value === originalSubject) {
                subjectInput.value = '';
                originalSubject = '';
            }
            if (!isUserEditedMessage || messageTextarea.value === originalMessage) {
                messageTextarea.value = '';
                originalMessage = '';
            }
        }
    }

    // Listen for user edits
    subjectInput.addEventListener('input', function() {
        isUserEditedSubject = subjectInput.value !== originalSubject;
    });
    messageTextarea.addEventListener('input', function() {
        isUserEditedMessage = messageTextarea.value !== originalMessage;
    });

    // Initial call to populate fields if a bulletin is pre-selected by the backend
    // The backend now handles the initial pre-selection of bulletin_id in the form object
    // and passes selected_bulletin, so Jinja handles initial HTML value for subject/message.
    // The JS below primarily handles dynamic changes if the user changes the dropdown.

    // If a bulletin was pre-selected by the backend, set the initial originalSubject and originalMessage
    // based on what Jinja rendered, so the JS doesn't immediately overwrite it or think it's user-edited.
    if (bulletinSelect.value && parseInt(bulletinSelect.value) !== 0) {
        originalSubject = subjectInput.value;
        originalMessage = messageTextarea.value;
    } else {
        // If no bulletin is pre-selected (or placeholder is selected), clear fields via JS
        // unless they were somehow pre-filled by browser
        if (!isUserEditedSubject) subjectInput.value = '';
        if (!isUserEditedMessage) messageTextarea.value = '';
        originalSubject = '';
        originalMessage = '';
    }

    bulletinSelect.addEventListener('change', updateFields);
    // End Bulletin auto-population logic
    
    // Email Group Preview Logic
    const emailGroupSelect = document.getElementById('email_group_id');
    const emailPreviewDiv = document.getElementById('email-preview');
    let emailGroupsData = [];
    try {
        const emailGroupsDataElement = document.getElementById('email-groups-data-json');
        if (emailGroupsDataElement) {
            emailGroupsData = JSON.parse(emailGroupsDataElement.textContent || '[]');
        }
    } catch (e) {
        console.error("Error parsing email groups data:", e);
    }

    function updateEmailPreview() {
        const selectedId = parseInt(emailGroupSelect.value);
        const selectedGroup = emailGroupsData.find(g => g.id === selectedId);

        if (selectedGroup && selectedGroup.emails && selectedGroup.emails.length > 0) {
            // Display emails as a list or comma-separated string
            emailPreviewDiv.innerHTML = '<strong>Recipients:</strong><br>' + selectedGroup.emails.join('<br>'); 
            // Or: emailPreviewDiv.textContent = 'Recipients: ' + selectedGroup.emails.join(', ');
        } else if (selectedGroup) {
            emailPreviewDiv.innerHTML = '<small class="text-muted">{{ _("No email addresses defined for this group.") }}</small>';
        } else {
            emailPreviewDiv.innerHTML = '<small class="text-muted">{{ _("Select an email group to see recipients.") }}</small>';
        }
    }

    // emailGroupSelect.addEventListener('change', updateEmailPreview);
    $('#email_group_id').on('change', updateEmailPreview);

    // Initial call to set preview if a group is pre-selected (though usually it won't be)
    updateEmailPreview(); 

});
</script>

{% endblock %} 