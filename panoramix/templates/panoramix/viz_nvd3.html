{% macro viz_html(viz) %}
<div id="{{ viz.token }}" style="height:100%; width: 100%">
  <img src="{{ url_for("static", filename="loading.gif") }}" class="loading">
  <div class="chart with-3d-shadow with-transitions" style="height:100%; width: 100%"></div>
</div>
{% endmacro %}

{% macro viz_js(viz) %}
<script>
  $( document ).ready(function() {
    function UTC(dttm){
      return v = new Date(dttm.getUTCFullYear(), dttm.getUTCMonth(), dttm.getUTCDate(),  dttm.getUTCHours(), dttm.getUTCMinutes(), dttm.getUTCSeconds());
    }
    var tickMultiFormat = d3.time.format.multi([
      [".%L", function(d) { return d.getMilliseconds(); }],
      [":%S", function(d) { return d.getSeconds(); }],
      ["%I:%M", function(d) { return d.getMinutes(); }],
      ["%I %p", function(d) { return d.getHours(); }],
      ["%a %d", function(d) { return d.getDay() && d.getDate() != 1; }],
      ["%b %d", function(d) { return d.getDate() != 1; }],
      ["%B", function(d) { return d.getMonth(); }],
      ["%Y", function() { return true; }]
    ]);
    colors = [
      "#FF5A5F", "#007A87", "#7B0051", "#00D1C1", "#8CE071", "#FFB400",
      "#FFAA91", "#B4A76C", "#9CA299", "#565A5C"
    ];
    var token = d3.select("#{{ viz.token }}");
    var jtoken = $("#{{ viz.token }}");
    var loading = $("#{{ viz.token }}").find("img.loading");
    var chart = $("#{{ viz.token }}").find("div.chart");
    var refresh = function(){
      chart.hide();
      loading.show();
      var url = "{{ viz.get_url(json="true")|safe }}";
      $.getJSON(url, function(data){
        nv.addGraph(function() {
          // chart_type is {{ viz.chart_type }}
          {% if viz.chart_type == 'line' %}
            {% if viz.form_data.show_brush == 'y' %}
              var chart = nv.models.lineWithFocusChart()
              var xext = chart.xAxis.scale().domain();
              chart
                .x2Axis
                .tickFormat(function (d) {return tickMultiFormat(UTC(new Date(d))); })
                .tickValues([]);
              chart.y2Axis.tickFormat(d3.format('.3s'));
            {% else %}
              var chart = nv.models.lineChart()
            {% endif %}
            chart.xScale(d3.time.scale());
            chart.xAxis
              .showMaxMin(false)
              .tickFormat(function (d) {return tickMultiFormat(new Date(d)); });
            chart.showLegend({{ "{}".format(viz.form_data.show_legend=='y')|lower }});
            chart.yAxis.tickFormat(d3.format('.3s'));

            {% if viz.form_data.contribution=='y' or viz.form_data.get("num_period_compare") %}
              chart.yAxis.tickFormat(d3.format('.3p'));
              chart.y2Axis.tickFormat(d3.format('.3p'));
            {% endif %}

          {% elif viz.chart_type == 'nvd3_bar' %}
            var chart = nv.models.multiBarChart()
              .showControls(true)   //Allow user to switch between 'Grouped' and 'Stacked' mode.
              .groupSpacing(0.1);   //Distance between each group of bars.
            chart.xAxis
              .showMaxMin(false)
              .tickFormat(function (d) {return tickMultiFormat(UTC(new Date(d))); });
            chart.yAxis.tickFormat(d3.format('.3s'));

          {% elif viz.chart_type == 'pie' %}
            var chart = nv.models.pieChart()
            chart.showLegend({{ "{}".format(viz.form_data.show_legend=='y')|lower }});
            {% if viz.form_data.donut=='y' %}
              chart.donut(true);
              chart.donutLabelsOutside(true);
            {% endif %}
            chart.labelsOutside(true);
            chart.cornerRadius(true);

          {% elif viz.chart_type == 'column' %}
            var chart = nv.models.multiBarChart()
              .reduceXTicks(false)
              .rotateLabels(45) ;
            chart.yAxis.tickFormat(d3.format('.3s'));

          {% elif viz.chart_type == 'compare' %}
            var chart = nv.models.cumulativeLineChart();
            chart.xScale(d3.time.scale());
            chart.xAxis
              .showMaxMin(false)
              .tickFormat(function (d) {return tickMultiFormat(new Date(d)); });
            chart.showLegend({{ "{}".format(viz.form_data.show_legend=='y')|lower }});
            chart.yAxis.tickFormat(d3.format('.3p'));

          {% elif viz.chart_type == 'bubble' %}
            var chart = nv.models.scatterChart();
            chart.xAxis.tickFormat(d3.format('.3s'));
            chart.yAxis.tickFormat(d3.format('.3s'));
            chart.showLegend({{ "{}".format(viz.form_data.show_legend=='y')|lower }});
            chart.pointRange([5, 5000]);

          {% elif viz.chart_type == 'stacked' %}
            var chart = nv.models.stackedAreaChart();
            chart.xScale(d3.time.scale());
            chart.xAxis
              .showMaxMin(false)
              .tickFormat(function (d) {return tickMultiFormat(new Date(d)); });
            chart.showLegend({{ "{}".format(viz.form_data.show_legend=='y')|lower }});
            chart.yAxis.tickFormat(d3.format('.3s'));

          {% endif %}

          {% if viz.chart_type in ("line", "stacked") and viz.form_data.rich_tooltip == 'y' %}
            chart.useInteractiveGuideline(true);
          {% endif %}
          {% if viz.form_data.y_axis_zero == 'y' %}
            chart.forceY([0, 1]);
          {% elif viz.form_data.y_log_scale == 'y' %}
            chart.yScale(d3.scale.log());
          {% endif %}

          {% if viz.form_data.x_log_scale == 'y' %}
            chart.xScale(d3.scale.log());
          {% endif %}


          token.select('.chart').append("svg")
            .datum(data)
            .transition().duration(500)
            .call(chart);

          return chart;
        });
        chart.show();
        loading.hide();
    }).fail(function(xhr) {
        var err = '<div class="alert alert-danger">' + xhr.responseText  + '</div>';
        loading.hide();
        chart.show();
        chart.html(err);
      });
    };
    refresh();
    jtoken.parent().find("a.refresh").click(refresh);
  });
</script>
{% endmacro %}

{% macro viz_css(viz) %}
{% endmacro %}
